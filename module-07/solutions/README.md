# Module 7 Solutions

This directory contains complete, working solutions for Module 7 labs, aligned with kubebuilder project structure and conventions.

## Files

- [**Dockerfile**](https://github.com/piyushjajoo/k8s-operators-course/blob/main/module-07/solutions/Dockerfile): Production-ready multi-stage Dockerfile
- [**rbac.yaml**](https://github.com/piyushjajoo/k8s-operators-course/blob/main/module-07/solutions/rbac.yaml): Optimized RBAC configuration
- [**security.yaml**](https://github.com/piyushjajoo/k8s-operators-course/blob/main/module-07/solutions/security.yaml): Security best practices
- [**leader-election.go**](https://github.com/piyushjajoo/k8s-operators-course/blob/main/module-07/solutions/leader-election.go): Complete main.go with leader election
- [**ha-deployment.yaml**](https://github.com/piyushjajoo/k8s-operators-course/blob/main/module-07/solutions/ha-deployment.yaml): High availability deployment with PDB
- [**ratelimiter.go**](https://github.com/piyushjajoo/k8s-operators-course/blob/main/module-07/solutions/ratelimiter.go): Rate limiting examples
- [**performance.go**](https://github.com/piyushjajoo/k8s-operators-course/blob/main/module-07/solutions/performance.go): Performance optimization examples
- [**helm-chart/**](https://github.com/piyushjajoo/k8s-operators-course/tree/main/module-07/solutions/helm-chart): Helm chart generated from Kustomize
- [**github-actions/**](https://github.com/piyushjajoo/k8s-operators-course/tree/main/module-07/solutions/github-actions): CI/CD workflows for automated releases

## Kubebuilder Integration

These solutions are designed to work with kubebuilder projects from Modules 1-6:

### Project Structure Reference
```
your-operator/
├── cmd/
│   └── main.go              # Use leader-election.go as reference
├── api/
│   └── v1/
│       └── database_types.go
├── internal/                # Entire directory is copied in Dockerfile
│   ├── controller/
│   │   └── database_controller.go  # Add performance.go patterns here
│   └── webhook/             # Created in Module 5
│       └── database_webhook.go     # Webhooks are packaged with the operator
├── config/
│   ├── manager/
│   │   ├── manager.yaml     # Use ha-deployment.yaml as reference
│   │   └── pdb.yaml         # Add for Pod Disruption Budget
│   ├── rbac/
│   │   └── role.yaml        # Generated from markers (see rbac.yaml)
│   ├── webhook/             # Webhook configurations
│   └── default/
├── Dockerfile               # Already generated by kubebuilder
└── Makefile                 # Use make targets for building/deploying
```

**Important:** The Dockerfile copies `internal/` (not just `internal/controller/`) to include both controllers AND webhooks in the final image.

## Usage

### 1. Container Image (Lab 7.1)
Kubebuilder already generates a Dockerfile. Use the kubebuilder make targets:
```bash
# Build image
make docker-build IMG=postgres-operator:v0.1.0

# Push to registry
make docker-push IMG=postgres-operator:v0.1.0

# Load to kind (for local development)
kind load docker-image postgres-operator:v0.1.0 --name k8s-operators-course
```

### 2. RBAC (Lab 7.2)
Review your controller RBAC markers and regenerate:
```bash
# View generated RBAC
cat config/rbac/role.yaml

# After updating markers, regenerate
make manifests
```

### 3. Security (Lab 7.2)
Update `config/manager/manager.yaml` with security contexts. Apply network policies:
```bash
# Create network policy directory
mkdir -p config/network-policy
# Add network policy and update kustomization.yaml
```

### 4. High Availability (Lab 7.3)
Update `config/manager/manager.yaml`:
- Set `replicas: 3`
- Add `--leader-elect` to args
- Create `config/manager/pdb.yaml` for Pod Disruption Budget

Deploy:
```bash
make deploy IMG=postgres-operator:v0.1.0
```

### 5. Performance (Lab 7.4)
Add to `internal/controller/database_controller.go`:
- Configure `WithOptions(controller.Options{...})` in SetupWithManager
- Add field indexes in `cmd/main.go`
- Register custom metrics with `metrics.Registry`

### 6. Helm Chart (Lab 7.1)
The `make helm-chart` target generates a Helm chart from Kustomize:
```bash
# Generate helm chart from kustomize
make helm-chart IMG=postgres-operator:v0.1.0

# Lint the chart
make helm-lint

# Package for distribution
make helm-package

# Install to cluster
make helm-install

# Uninstall
make helm-uninstall
```

## Key Commands

```bash
# Build and push image
make docker-build docker-push IMG=<registry>/postgres-operator:v0.1.0

# Deploy operator (Kustomize)
make deploy IMG=<registry>/postgres-operator:v0.1.0

# Undeploy
make undeploy

# Regenerate manifests (CRDs, RBAC, webhooks)
make manifests

# Install/uninstall CRDs only
make install
make uninstall

# Helm chart commands
make helm-chart IMG=<registry>/postgres-operator:v0.1.0
make helm-lint
make helm-package
make helm-install
make helm-uninstall
```

## Helm Chart Generation from Kustomize

Add these targets to your Makefile to generate Helm charts automatically:

```makefile
CHART_NAME ?= postgres-operator
CHART_VERSION ?= 0.1.0
CHART_DIR ?= charts/$(CHART_NAME)

##@ Helm

.PHONY: helm-chart
helm-chart: manifests kustomize ## Generate Helm chart from Kustomize (includes CRDs, RBAC, Deployment, Webhooks)
	@echo "Generating Helm chart with ALL operator components..."
	@mkdir -p $(CHART_DIR)/templates
	@# Create Chart.yaml
	@printf '%s\n' \
		'apiVersion: v2' \
		'name: $(CHART_NAME)' \
		'description: A Helm chart for $(CHART_NAME) - includes CRDs, RBAC, and webhooks' \
		'type: application' \
		'version: $(CHART_VERSION)' \
		'appVersion: "$(VERSION)"' \
		> $(CHART_DIR)/Chart.yaml
	@# Create values.yaml
	@printf '%s\n' \
		'image:' \
		'  repository: $(IMAGE_TAG_BASE)' \
		'  tag: $(VERSION)' \
		'  pullPolicy: IfNotPresent' \
		'' \
		'replicaCount: 1' \
		'' \
		'resources:' \
		'  limits:' \
		'    cpu: 500m' \
		'    memory: 128Mi' \
		'  requests:' \
		'    cpu: 10m' \
		'    memory: 64Mi' \
		'' \
		'leaderElection:' \
		'  enabled: false' \
		'' \
		'namespace: $(CHART_NAME)-system' \
		> $(CHART_DIR)/values.yaml
	@# Generate ALL manifests from kustomize (CRDs, RBAC, Deployment, Webhooks)
	@cd config/manager && $(KUSTOMIZE) edit set image controller=$(IMG)
	@$(KUSTOMIZE) build config/default > $(CHART_DIR)/templates/manifests.yaml
	@echo "Helm chart generated at $(CHART_DIR)"
	@echo "Contents include: CRDs, RBAC (ServiceAccount, ClusterRole, ClusterRoleBinding), Deployment, Webhooks"

.PHONY: helm-package
helm-package: helm-chart ## Package Helm chart
	@mkdir -p dist
	helm package $(CHART_DIR) -d dist/

.PHONY: helm-lint
helm-lint: helm-chart ## Lint Helm chart
	helm lint $(CHART_DIR)

.PHONY: helm-template
helm-template: helm-chart ## Render Helm templates locally
	helm template $(CHART_NAME) $(CHART_DIR)

.PHONY: helm-install
helm-install: helm-chart ## Install Helm chart to cluster
	helm upgrade --install $(CHART_NAME) $(CHART_DIR) \
		--namespace $(CHART_NAME)-system \
		--create-namespace

.PHONY: helm-uninstall
helm-uninstall: ## Uninstall Helm chart
	helm uninstall $(CHART_NAME) --namespace $(CHART_NAME)-system
```

## Notes

- All solutions follow kubebuilder project conventions
- Security configurations match kubebuilder defaults (distroless, non-root, capabilities dropped)
- Leader election is built into kubebuilder via `--leader-elect` flag
- Performance optimizations use controller-runtime's built-in features
- Helm charts are generated from Kustomize; the chart packages all resources into a single `manifests.yaml`
- For production Helm charts, consider splitting resources into separate templates for better customization
