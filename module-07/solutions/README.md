# Module 7 Solutions

This directory contains complete, working solutions for Module 7 labs, aligned with kubebuilder project structure and conventions.

## Files

- **Dockerfile**: Production-ready multi-stage Dockerfile (matches kubebuilder default)
- **rbac.yaml**: Optimized RBAC configuration (generated via kubebuilder markers)
- **security.yaml**: Security best practices (deployment, network policy)
- **leader-election.go**: Complete `cmd/main.go` with leader election configuration
- **ha-deployment.yaml**: High availability deployment with PDB (kubebuilder `config/manager/` format)
- **ratelimiter.go**: Rate limiting using controller-runtime and golang.org/x/time/rate
- **performance.go**: Performance optimization examples with kubebuilder patterns
- **helm-chart/**: Complete Helm chart for operator distribution
  - `templates/crds.yaml`: Custom Resource Definitions
  - `templates/rbac.yaml`: ServiceAccount, ClusterRole, ClusterRoleBinding, leader election Role
  - `templates/deployment.yaml`: Controller manager Deployment and PDB
  - `templates/webhook.yaml`: Validating/Mutating webhooks (optional)
  - `templates/_helpers.tpl`: Helm template helpers
  - `templates/NOTES.txt`: Post-install instructions
- **github-actions/**: CI/CD workflows for automated releases
  - `release.yaml`: Main release workflow (Docker + Helm to GHCR)
  - `helm-gh-pages.yaml`: Alternative GitHub Pages Helm repository

## Kubebuilder Integration

These solutions are designed to work with kubebuilder projects from Modules 1-6:

### Project Structure Reference
```
your-operator/
├── cmd/
│   └── main.go              # Use leader-election.go as reference
├── api/
│   └── v1/
│       └── database_types.go
├── internal/                # Entire directory is copied in Dockerfile
│   ├── controller/
│   │   └── database_controller.go  # Add performance.go patterns here
│   └── webhook/             # Created in Module 5
│       └── database_webhook.go     # Webhooks are packaged with the operator
├── config/
│   ├── manager/
│   │   ├── manager.yaml     # Use ha-deployment.yaml as reference
│   │   └── pdb.yaml         # Add for Pod Disruption Budget
│   ├── rbac/
│   │   └── role.yaml        # Generated from markers (see rbac.yaml)
│   ├── webhook/             # Webhook configurations
│   └── default/
├── Dockerfile               # Already generated by kubebuilder
└── Makefile                 # Use make targets for building/deploying
```

**Important:** The Dockerfile copies `internal/` (not just `internal/controller/`) to include both controllers AND webhooks in the final image.

## Usage

### 1. Container Image (Lab 7.1)
Kubebuilder already generates a Dockerfile. Use the kubebuilder make targets:
```bash
# Build image
make docker-build IMG=database-operator:v0.1.0

# Push to registry
make docker-push IMG=database-operator:v0.1.0

# Load to kind (for local development)
kind load docker-image database-operator:v0.1.0 --name k8s-operators-course
```

### 2. RBAC (Lab 7.2)
Review your controller RBAC markers and regenerate:
```bash
# View generated RBAC
cat config/rbac/role.yaml

# After updating markers, regenerate
make manifests
```

### 3. Security (Lab 7.2)
Update `config/manager/manager.yaml` with security contexts. Apply network policies:
```bash
# Create network policy directory
mkdir -p config/network-policy
# Add network policy and update kustomization.yaml
```

### 4. High Availability (Lab 7.3)
Update `config/manager/manager.yaml`:
- Set `replicas: 3`
- Add `--leader-elect` to args
- Create `config/manager/pdb.yaml` for Pod Disruption Budget

Deploy:
```bash
make deploy IMG=database-operator:v0.1.0
```

### 5. Performance (Lab 7.4)
Add to `internal/controller/database_controller.go`:
- Configure `WithOptions(controller.Options{...})` in SetupWithManager
- Add field indexes in `cmd/main.go`
- Register custom metrics with `metrics.Registry`

### 6. Helm Chart (Optional - for distribution)
Copy and customize `helm-chart/` directory. For kubebuilder projects, Kustomize is preferred:
```bash
# Deploy with Kustomize (recommended)
make deploy IMG=database-operator:v0.1.0

# Or package for Helm distribution
helm package charts/database-operator
```

## Key Commands

```bash
# Build and push image
make docker-build docker-push IMG=<registry>/database-operator:v0.1.0

# Deploy operator (Kustomize)
make deploy IMG=<registry>/database-operator:v0.1.0

# Undeploy
make undeploy

# Regenerate manifests (CRDs, RBAC, webhooks)
make manifests

# Install/uninstall CRDs only
make install
make uninstall

# Helm chart commands (add targets from lab 7.1)
make helm-chart IMG=<registry>/database-operator:v0.1.0
make helm-lint
make helm-package
make helm-install
make helm-uninstall
```

## Helm Chart Generation from Kustomize

Add these targets to your Makefile to generate Helm charts automatically:

```makefile
CHART_NAME ?= database-operator
CHART_VERSION ?= 0.1.0
CHART_DIR ?= charts/$(CHART_NAME)

##@ Helm

.PHONY: helm-chart
helm-chart: manifests kustomize ## Generate Helm chart from Kustomize
	@mkdir -p $(CHART_DIR)/templates
	@cat > $(CHART_DIR)/Chart.yaml <<EOF
apiVersion: v2
name: $(CHART_NAME)
description: A Helm chart for $(CHART_NAME)
type: application
version: $(CHART_VERSION)
appVersion: "$(VERSION)"
EOF
	@cat > $(CHART_DIR)/values.yaml <<EOF
image:
  repository: $(IMAGE_TAG_BASE)
  tag: $(VERSION)
  pullPolicy: IfNotPresent
replicaCount: 1
leaderElection:
  enabled: false
EOF
	@cd config/manager && $(KUSTOMIZE) edit set image controller=$(IMG)
	@$(KUSTOMIZE) build config/default > $(CHART_DIR)/templates/manifests.yaml
	@echo "Helm chart generated at $(CHART_DIR)"

.PHONY: helm-package
helm-package: helm-chart ## Package Helm chart
	@mkdir -p dist
	helm package $(CHART_DIR) -d dist/

.PHONY: helm-lint
helm-lint: helm-chart ## Lint Helm chart
	helm lint $(CHART_DIR)

.PHONY: helm-install
helm-install: helm-chart ## Install Helm chart
	helm upgrade --install $(CHART_NAME) $(CHART_DIR) \
		--namespace $(CHART_NAME)-system --create-namespace

.PHONY: helm-uninstall
helm-uninstall: ## Uninstall Helm chart
	helm uninstall $(CHART_NAME) --namespace $(CHART_NAME)-system
```

## Notes

- All solutions follow kubebuilder project conventions
- Security configurations match kubebuilder defaults (distroless, non-root, capabilities dropped)
- Leader election is built into kubebuilder via `--leader-elect` flag
- Performance optimizations use controller-runtime's built-in features
- Helm charts are optional; Kustomize (via `make deploy`) is preferred for kubebuilder projects

